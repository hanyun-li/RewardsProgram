<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="chat room">
	<meta name="author" content="hanyun.li">
	<meta name="generator" content="v1.0">
	<title>聊天房</title>

	<link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/product/">

	<link th:href="@{/assets/dist/css/bootstrap.min.css}" rel="stylesheet">
	<link th:href="@{/chat/css/rolling.css}" rel="stylesheet">
	<link th:href="@{/chat/css/style.css}" rel="stylesheet">
	<link rel="shortcut icon" th:href="@{/assets/icon/favicon.ico}" />
</head>
<body class="room">
	<div class="scrollbar-macosx">
		<div class="header">
			<div class="toptext">
				<a href="/chat">
					<svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor" class="bi bi-arrow-return-left" viewBox="0 0 16 16">
						<path fill-rule="evenodd" d="M14.5 1.5a.5.5 0 0 1 .5.5v4.8a2.5 2.5 0 0 1-2.5 2.5H2.707l3.347 3.346a.5.5 0 0 1-.708.708l-4.2-4.2a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 8.3H12.5A1.5 1.5 0 0 0 14 6.8V2a.5.5 0 0 1 .5-.5z"/>
					</svg>
					返回大厅
				</a>
			</div>
			<ul class="topnavlist">
				<li class="userlist">
					<a>
						<svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor" class="bi bi-person-lines-fill" viewBox="0 0 16 16">
							<path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z"/>
						</svg>
					</a>
					<div class="popover fade bottom in">
						<div class="arrow"></div>
						<h3 class="popover-title"></h3>
<!--						<div class="popover-content scrollbar-macosx">-->
<!--							<ul>-->
<!--								<li>-->
<!--									<img th:src="@{/chat/images/user/12.png}" alt="portrait_1">-->
<!--									<b>美国队长</b>-->
<!--								</li>-->
<!--								<li>-->
<!--									<img th:src="@{/chat/images/user/12.png}" alt="portrait_1">-->
<!--									<b>美国队长</b>-->
<!--								</li>-->
<!--							</ul>-->
<!--						</div>-->
					</div>
				</li>
			</ul>
		</div>
		<div class="main container">
			<div class="col-md-12">
				<ul class="chat_info">
					<li class="systeminfo">
						<span style="font-size: large">文明聊天，温馨你我</span>
					</li>
					<li class="systeminfo">
						<span style="font-size: large">欢迎来到激励计划聊天室，下面请大家愉快的玩耍吧！</span>
					</li>
					<li class="systeminfo">
						<span id="username" style="display: none" th:text="${username}"></span>
					</li>
				</ul>
			</div>
		</div>
		<div class="input">
			<div class="center">
				<div class="text">
					<div class="input-group mb-3">
						<input id="sessionId" type="hidden">
						<input id="msg" type="text" class="form-control" placeholder="输入聊天信息..." aria-describedby="subxx">
						<button style="border:none" class="btn btn-outline-light" type="button" onclick="sendMsgToServer()">
							<svg xmlns="http://www.w3.org/2000/svg" style="color: #b6effb" width="21" height="21" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
								<path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
							</svg>
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script th:src="@{/assets/js/jquery-1.11.2.min.js}"></script>
	<script th:src="@{/assets/js/bootstrap.min.js}"></script>
	<script th:src="@{/chat/js/rolling.js}"></script>
	<script th:src="@{/assets/js/public.js}"></script>

	<script th:inline="javascript">

		/**
		 * WebSocket客户端
		 *
		 * 使用说明：
		 * 1、WebSocket客户端通过回调函数来接收服务端消息。例如：webSocket.onmessage
		 * 2、WebSocket客户端通过send方法来发送消息给服务端。例如：webSocket.send();
		 */
		function getWebSocket() {
			/**
			 * WebSocket客户端 PS：URL开头表示WebSocket协议 中间是域名端口 结尾是服务端映射地址
			 */
			var webSocket = new WebSocket(/*[[${webSocketUrl}]]*/ 'ws://127.0.0.1:8080/chat');
			/**
			 * 当服务端打开连接
			 */
			webSocket.onopen = function (event) {
				console.log('WebSocket打开连接');
			};

			/**
			 * 当服务端发来消息：1.广播消息 2.更新在线人数
			 */
			webSocket.onmessage = function (event) {
				console.log('WebSocket收到消息：%c' + event.data, 'color:green');
				//获取服务端消息
				var message = JSON.parse(event.data) || {};
				var $messageContainer = $('.chat_info');
				$('#sessionId').textContent = message.sessionId;
				//喉咙发炎
				if (message.type === 'SPEAK') {
					$messageContainer.append(
						'<li class="left">' +
						'<img src="/chat/images/user/12.png">' +
						'<b>' + message.username + '</b>\n' +
						'<i>' + getNowTime()+ '</i>\n' +
						'<div class="aaa">' + message.msg + '</div>\n' +
						'</li>');
				}

				// 滚动条滚到最下面
				$('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').animate({
					scrollTop: $('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').prop('scrollHeight')
				}, 500);
				$('.popover-title').text('房间人数：' + message.onlineCount + '人');
				//防止刷屏
				// var $cards = $messageContainer.children('.mdui-card:visible').toArray();
				// if ($cards.length > 5) {
				// 	$cards.forEach(function (item, index) {
				// 		index < $cards.length - 5 && $(item).slideUp('fast');
				// 	});
				// }
			};

			/**
			 * 关闭连接
			 */
			webSocket.onclose = function (event) {
				console.log('WebSocket关闭连接');
			};

			/**
			 * 通信失败
			 */
			webSocket.onerror = function (event) {
				console.log('WebSocket发生异常');

			};
			return webSocket;
		}

		var webSocket = getWebSocket();

		var x = 12;
		var y = 1;
		// 文档加载后，生成行x~y中的随机整数
		var rand = parseInt(Math.random() * (x - y + 1) + y);

		/**
		 * 通过WebSocket对象发送消息给服务端
		 */
		function sendMsgToServer() {

			var $message = $('#msg'); // 获取聊天内容
			if ($message.val()) {
				webSocket.send(JSON.stringify({sessionId: $('#sessionId').text(), username: $('#username').text(), msg: $message.val()}));

				var str = $message.val(); // 获取聊天内容
				str = str.replace(/\</g,'&lt;');
				str = str.replace(/\>/g,'&gt;');
				str = str.replace(/\n/g,'<br/>');
				str = str.replace(/\[em_([0-9]*)\]/g,'<img src="/chat/images/face/$1.gif" alt="" />');
				if(str!='') {

					sends_message($('#username').text(), rand, str); // sends_message(昵称,头像id,聊天内容);


					// 滚动条滚到最下面
					$('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').animate({
						scrollTop: $('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').prop('scrollHeight')
					}, 500);

				}
				$('.text input').val(''); // 清空输入框
				$('.text input').focus(); // 输入框获取焦点

			}

		}

		function sends_message (userName, userPortrait, message) {
			if(message!='') {
				$('.main .chat_info').html($('.main .chat_info').html() + '<li class="right"><img src="/chat/images/user/' + userPortrait + '.png" alt=""><b>' + userName + '</b><i>' + getNowTime() + '</i><div class="aaa">' + message  +'</div></li>');
			}
		}

		/**
		 * 获取当前时间
		 */
		function getNowTime() {
			let date = new Date();
			let year = date.getFullYear();
			// 在日期格式中，月份是从0开始的，因此要加0，使用三元表达式在小于10的前面加0，以达到格式统一  如 09:11:05
			let month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
			let day = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
			let hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
			let minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
			// let seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
			// 拼接
			return year + "-" + month + "-" + day + " " + hours + ":" + minutes;
		}

		/**
		 * 清屏
		 */
		function clearMsg() {
			$(".message-container").empty();
		}

		/**
		 * 使用ENTER发送消息
		 */
		document.onkeydown = function (event) {
			var e = event || window.event || arguments.callee.caller.arguments[0];
			e.keyCode === 13 && sendMsgToServer();
		};
	</script>
</body>
</html>