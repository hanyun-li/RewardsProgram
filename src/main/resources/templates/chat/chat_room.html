<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="chat room">
	<meta name="author" content="hanyun.li">
	<meta name="generator" content="v1.0">
	<title>聊天房</title>

	<link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/product/">

	<link th:href="@{/assets/dist/css/bootstrap.min.css}" rel="stylesheet">
	<link th:href="@{/chat/css/rolling.css}" rel="stylesheet">
	<link th:href="@{/chat/css/style.css}" rel="stylesheet">
	<link rel="shortcut icon" th:href="@{/assets/icon/favicon.ico}" />
</head>
<body class="room">
	<div class="scrollbar-macosx">
		<div class="header">
			<div class="toptext">
				<a href="/chat">
					<svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor" class="bi bi-arrow-return-left" viewBox="0 0 16 16">
						<path fill-rule="evenodd" d="M14.5 1.5a.5.5 0 0 1 .5.5v4.8a2.5 2.5 0 0 1-2.5 2.5H2.707l3.347 3.346a.5.5 0 0 1-.708.708l-4.2-4.2a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 8.3H12.5A1.5 1.5 0 0 0 14 6.8V2a.5.5 0 0 1 .5-.5z"/>
					</svg>
					返回大厅
				</a>
			</div>
			<ul class="topnavlist">
				<li class="userlist">
					<a>
						<svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor" class="bi bi-person-lines-fill" viewBox="0 0 16 16">
							<path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z"/>
						</svg>
					</a>
					<div class="popover fade bottom in">
						<div class="arrow"></div>
						<h3 class="popover-title"></h3>
					</div>
				</li>
			</ul>
		</div>
		<div class="main container">
			<div class="col-md-12">
				<ul class="chat_info">
					<li class="systeminfo">
						<span style="font-size: large">文明聊天，温馨你我</span>
					</li>
					<li class="systeminfo">
						<span style="font-size: large">欢迎来到激励计划聊天室，下面请大家愉快的玩耍吧！</span>
					</li>
					<li class="systeminfo">
						<span id="username" style="display: none" th:text="${username}"></span>
						<span id="avatarUrl" style="display: none" th:text="${avatarUrl}"></span>
						<span id="webSocketUrl" style="display: none" th:text="${webSocketUrl}"></span>
					</li>
				</ul>
			</div>
		</div>

		<div class="input">
			<div class="center">
				<div style="width: 100%; display: flex">
					<!--填充左侧空间-->
					<div style="width: 5%"></div>
					<!--开启表情框按钮-->
					<div onclick="clickViewOrHiddenEmoji()">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-emoji-heart-eyes-fill" viewBox="0 0 16 16">
							<path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.756 4.566c.763-1.424 4.02-.12.952 3.434-4.496-1.596-2.35-4.298-.952-3.434zm6.559 5.448a.5.5 0 0 1 .548.736A4.498 4.498 0 0 1 7.965 13a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .548-.736h.005l.017.005.067.015.252.055c.215.046.515.108.857.169.693.124 1.522.242 2.152.242.63 0 1.46-.118 2.152-.242a26.58 26.58 0 0 0 1.109-.224l.067-.015.017-.004.005-.002zm-.07-5.448c1.397-.864 3.543 1.838-.953 3.434-3.067-3.554.19-4.858.952-3.434z"/>
						</svg>
					</div>
				</div>
				<div class="text">

					<!--表情包容器展示-->
					<div id="fallContainer" class="fall" style="display: none">
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/active_off_work.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/dawn_of_get_off_work.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/get_up_to_work.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/good_morning.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/mood_written_on_face.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/not_do_want_to_work.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/standby.jpg" alt="" onclick="clickEmoticons(this)">
						</div>

						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/the_holiday_is_over.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/want_to_sleep.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
						<div class="box">
							<img src="/chat/images/emoticons/pigdemon/working.jpg" alt="" onclick="clickEmoticons(this)">
						</div>
					</div>

					<div class="input-group mb-3">
						<input id="sessionId" type="hidden">
						<input id="msg" type="text" class="form-control" placeholder="输入聊天信息..." aria-describedby="subxx">
						<button style="border:none" class="btn btn-outline-light" type="button" onclick="sendMsgToServer()">
							<svg xmlns="http://www.w3.org/2000/svg" style="color: #b6effb" width="21" height="21" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
								<path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
							</svg>
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script th:src="@{/assets/js/jquery-1.11.2.min.js}"></script>
	<script th:src="@{/assets/js/bootstrap.min.js}"></script>
	<script th:src="@{/chat/js/rolling.js}"></script>
	<script th:src="@{/assets/js/public.js}"></script>

	<script th:inline="javascript">
		// 避免重复连接
		var lockReconnect = false;
		// webSocket连接地址
		var wsUrl = $('#webSocketUrl').text();
		var tt;

		/**
		 * WebSocket客户端（重新链接，调用该函数即可）
		 *
		 * 使用说明：
		 * 1、WebSocket客户端通过回调函数来接收服务端消息。例如：webSocket.onmessage
		 * 2、WebSocket客户端通过send方法来发送消息给服务端。例如：webSocket.send();
		 */
		function getWebSocket() {
			/**
			 * WebSocket客户端 PS：URL开头表示WebSocket协议 中间是域名端口 结尾是服务端映射地址
			 */
			var webSocket = new WebSocket(wsUrl);

			/**
			 * 当服务端打开连接
			 */
			webSocket.onopen = function (event) {
				console.log('WebSocket打开连接');
			};

			/**
			 * 当服务端发来消息：1.广播消息 2.更新在线人数
			 */
			webSocket.onmessage = function (event) {
				console.log('WebSocket收到消息：%c' + event.data, 'color:green');
				// 获取服务端消息
				var message = JSON.parse(event.data) || {};

				// 如果收到"PONG"指令，说明是服务端返回的心跳响应
				if (message.type === 'PONG') {
					// 收到消息后，启动心跳检测机制
					heartCheck.start();
				}

				var $messageContainer = $('.chat_info');
				$('#sessionId').textContent = message.sessionId;
				// 发送消息
				if (message.type === 'SPEAK') {
					$messageContainer.append(
						'<li class="left">' +
						'<img src="' + message.avatarUrl + '">' +
						'<b>' + message.username + '</b>\n' +
						'<i>' + getNowTime()+ '</i>\n' +
						'<div style="background: #FFFFFF; border-radius: 5px;" class="aaa">' + message.msg + '</div>\n' +
						'</li>');

					// 发送表情图片
				} else if (message.type === 'EMOJI') {
					$messageContainer.append(
							'<li class="left">' +
							'<img src="' + message.avatarUrl + '">' +
							'<b>' + message.username + '</b>\n' +
							'<i>' + getNowTime()+ '</i>\n' +
							'<div style="background: #FFFFFF; border-radius: 5px;" class="aaa"><img src="' + message.msg +'"></div>\n' +
							'</li>');
				}

				// 滚动条滚到最下面
				$('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').animate({
					scrollTop: $('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').prop('scrollHeight')
				}, 500);
				$('.popover-title').text('房间人数：' + message.onlineCount + '人');
				//防止刷屏
				// var $cards = $messageContainer.children('.mdui-card:visible').toArray();
				// if ($cards.length > 5) {
				// 	$cards.forEach(function (item, index) {
				// 		index < $cards.length - 5 && $(item).slideUp('fast');
				// 	});
				// }
			};

			/**
			 * 关闭连接
			 */
			webSocket.onclose = function (event) {
				console.log('WebSocket关闭连接');
				// 断线重连
				reconnect();
			};

			/**
			 * 通信失败
			 */
			webSocket.onerror = function (event) {
				console.log('WebSocket发生异常');
				// 异常重连
				reconnect();
			};
			return webSocket;
		}

		var webSocket = getWebSocket();

		// 心跳检测
		var heartCheck = {
			timeout: 50000,
			timeoutObj: null,
			start: function(){
				console.log('start heartbeat detection !');
				this.timeoutObj && clearTimeout(this.timeoutObj);
				this.timeoutObj = setTimeout(function(){
					// 这里发送一个心跳(PING指令)，后端收到后，返回一个心跳消息(PONG指令)
					webSocket.send(JSON.stringify({msg: 'PING'}));
					console.log('send PING !');
				}, this.timeout)
			}
		}

		// 断线重连
		function reconnect() {
			if(lockReconnect) {
				return;
			};
			lockReconnect = true;
			//没连接上会一直重连，设置延迟避免请求过多
			tt && clearTimeout(tt);
			tt = setTimeout(function () {
				getWebSocket();
				lockReconnect = false;
			}, 10000);
		}

		/**
		 * 点击表情包事件（作用：点击表情后发送）
		 */
		function clickEmoticons(that) {
			// 将表情包展示框隐藏
			const fall = $('#fallContainer');
			fall.css("display","none");

			// 给服务器发送表情包数据
			webSocket.send(JSON.stringify({sessionId: $('#sessionId').text(), type : "EMOJI", username: $('#username').text(), avatarUrl: $('#avatarUrl').text(), msg: that.src}));

			sendEmoji($('#username').text(), $('#avatarUrl').text(), that.src);
		}

		/**
		 * 点击表情包容器事件（作用：点击表情包容器后，弹出表情窗口）
		 */
		function clickViewOrHiddenEmoji() {
			// 将表情包展示框隐藏
			const fall = $('#fallContainer');
			if (fall.css("display") === 'none') {
				fall.css("display", 'block');
			} else {
				fall.css("display", 'none');
			}
		}

		/**
		 * 通过WebSocket对象发送消息给服务端
		 */
		function sendMsgToServer() {

			var $message = $('#msg'); // 获取聊天内容
			if ($message.val()) {
				webSocket.send(JSON.stringify({sessionId: $('#sessionId').text(), username: $('#username').text(), avatarUrl: $('#avatarUrl').text(), msg: $message.val()}));

				var str = $message.val(); // 获取聊天内容
				str = str.replace(/\</g,'&lt;');
				str = str.replace(/\>/g,'&gt;');
				str = str.replace(/\n/g,'<br/>');
				str = str.replace(/\[em_([0-9]*)\]/g,'<img src="/chat/images/face/$1.gif" alt="" />');
				if(str!='') {

					sends_message($('#username').text(), $('#avatarUrl').text(), str); // sends_message(昵称,头像id,聊天内容);


					// 滚动条滚到最下面
					$('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').animate({
						scrollTop: $('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').prop('scrollHeight')
					}, 500);

				}
				$('.text input').val(''); // 清空输入框
				$('.text input').focus(); // 输入框获取焦点

			}

		}

		/**
		 * 发送消息
		 */
		function sends_message (userName, userPortrait, message) {
			if(message !== '') {
				$('.main .chat_info').html($('.main .chat_info').html() + '<li class="right"><img src="' + userPortrait + '" alt=""><b>' + userName + '</b><i>' + getNowTime() + '</i><div style="background: #FFFFFF; border-radius: 5px;" class="aaa">' + message  +'</div></li>');
			}
		}

		/**
		 * 发送表情
		 */
		function sendEmoji (userName, userPortrait, imgSrc) {
			if(imgSrc !== '') {
				$('.main .chat_info').html($('.main .chat_info').html() + '<li class="right"><img src="' + userPortrait + '" alt=""><b>' + userName + '</b><i>' + getNowTime() + '</i><div style="background: #FFFFFF; border-radius: 5px;" class="aaa"><img src="' + imgSrc +'"></div></li>');

				// 滚动条滚到最下面
				$('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').animate({
					scrollTop: $('.scrollbar-macosx.scroll-content.scroll-scrolly_visible').prop('scrollHeight')
				}, 500);
			}
		}

		/**
		 * 获取当前时间
		 */
		function getNowTime() {
			let date = new Date();
			let year = date.getFullYear();
			// 在日期格式中，月份是从0开始的，因此要加0，使用三元表达式在小于10的前面加0，以达到格式统一  如 09:11:05
			let month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
			let day = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
			let hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
			let minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
			// let seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
			// 拼接
			return year + "-" + month + "-" + day + " " + hours + ":" + minutes;
		}

		/**
		 * 清屏
		 */
		function clearMsg() {
			$(".message-container").empty();
		}

		/**
		 * 使用ENTER发送消息
		 */
		document.onkeydown = function (event) {
			var e = event || window.event || arguments.callee.caller.arguments[0];
			e.keyCode === 13 && sendMsgToServer();
		};

	</script>
</body>
</html>